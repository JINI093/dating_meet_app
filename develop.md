# 좋아요 & 슈퍼챗 전송 기능 구현 명령어

## 핵심 요구사항
- UI 절대 수정 금지
- 더미 데이터 생성 금지  
- AWS 데이터베이스에 모든 액션 기록
- 실시간 데이터 처리

## Claude Code 명령어

### 메인 구현 명령어
```
Flutter 데이팅앱의 이성카드에서 좋아요와 슈퍼챗 전송 기능을 구현해주세요.

핵심 요구사항:
1. UI는 절대 변경하지 말고 기존 UI 이벤트 핸들러에만 로직 연결
2. 더미 데이터는 생성하지 말고 AWS 데이터베이스에만 저장
3. 모든 좋아요와 슈퍼챗 전송 내역을 AWS에 기록

구현할 기능:

【좋아요 전송 기능】
- 기존 좋아요 버튼 클릭 시 AWS DynamoDB에 좋아요 데이터 저장
- 전송자ID, 수신자ID, 전송시간, 액션타입(LIKE) 기록
- 중복 좋아요 방지 로직 (이미 평가한 사용자 체크)
- 좋아요 전송 후 다음 카드로 자동 이동
- 상호 좋아요 시 매칭 생성 로직

【슈퍼챗 전송 기능】  
- 기존 슈퍼챗 버튼 클릭 시 메시지 입력 후 AWS에 저장
- 전송자ID, 수신자ID, 메시지내용, 전송시간, 액션타입(SUPERCHAT) 기록
- 슈퍼챗 포인트 차감 로직 (사용자 포인트 테이블 업데이트)
- 슈퍼챗 전송 후 다음 카드로 자동 이동
- 수신자에게 실시간 알림 전송

【데이터베이스 구조】
DynamoDB 테이블 구성:
1. Likes 테이블 - 모든 좋아요/슈퍼챗 기록
2. Matches 테이블 - 상호 좋아요 시 매칭 정보
3. UserPoints 테이블 - 사용자 포인트 관리
4. Notifications 테이블 - 실시간 알림 관리

【비즈니스 로직】
- 하루 좋아요 전송 제한 (예: 20회)
- 슈퍼챗 비용 차감 (예: 100포인트)
- 이미 평가한 사용자 재평가 방지
- 자기 자신에게 좋아요 방지
- 매칭 성사 시 양쪽 사용자에게 알림

【에러 처리】
- 네트워크 오류 시 재시도 로직
- 포인트 부족 시 충전 유도
- 일일 제한 초과 시 안내 메시지
- AWS 서비스 오류 시 대체 로직
```

### 세부 구현 명령어

#### 1. 좋아요 전송 시스템 구현
```
좋아요 전송 기능을 AWS 백엔드와 연동하여 구현해주세요.

구현 사항:
1. 기존 좋아요 버튼의 onPressed 이벤트에 AWS API 호출 로직 추가
2. DynamoDB 'Likes' 테이블에 다음 데이터 저장:
   - likeId: 고유 ID (UUID)
   - fromUserId: 전송자 사용자 ID (현재 로그인 사용자)
   - toUserId: 수신자 사용자 ID (현재 카드의 사용자)
   - actionType: "LIKE"
   - createdAt: 전송 시간 (ISO 8601)
   - isActive: true

3. 중복 좋아요 방지:
   - 전송 전 동일한 fromUserId + toUserId 조합 존재 여부 확인
   - 이미 평가한 경우 에러 처리 및 다음 카드로 이동

4. 상호 좋아요 체크:
   - 수신자가 이미 나에게 좋아요를 보냈는지 확인
   - 상호 좋아요인 경우 'Matches' 테이블에 매칭 데이터 생성
   - 매칭 성사 시 양쪽 사용자에게 푸시 알림 전송

5. 일일 제한 체크:
   - 오늘 날짜로 전송한 좋아요 개수 확인
   - 제한 초과 시 안내 메시지 표시 후 리턴

API 엔드포인트: POST /api/likes
에러 처리: 모든 AWS 오류에 대한 사용자 친화적 메시지
```

#### 2. 슈퍼챗 전송 시스템 구현  
```
슈퍼챗 전송 기능을 포인트 시스템과 함께 구현해주세요.

구현 사항:
1. 기존 슈퍼챗 버튼 클릭 시:
   - 메시지 입력 다이얼로그 표시 (기존 UI 활용)
   - 현재 사용자 포인트 확인 (DynamoDB 'UserPoints' 테이블)
   - 포인트 부족 시 충전 안내 후 리턴

2. 슈퍼챗 전송 시 DynamoDB에 저장:
   'Likes' 테이블:
   - likeId: 고유 ID
   - fromUserId: 전송자 ID
   - toUserId: 수신자 ID  
   - actionType: "SUPERCHAT"
   - message: 슈퍼챗 메시지 내용
   - pointsUsed: 사용된 포인트 (100포인트)
   - createdAt: 전송 시간

3. 포인트 차감:
   - 'UserPoints' 테이블에서 사용자 포인트 차감
   - 트랜잭션 처리로 데이터 일관성 보장
   - 포인트 사용 내역을 'PointsHistory' 테이블에 기록

4. 실시간 알림:
   - AWS SNS를 통해 수신자에게 푸시 알림 전송
   - 알림 내용: "[발신자명]님이 슈퍼챗을 보냈습니다"
   - 'Notifications' 테이블에 알림 기록

5. 슈퍼챗 특별 처리:
   - 매칭 없이도 메시지 전송 가능
   - 수신자의 슈퍼챗 받은함에 우선 표시
   - 슈퍼챗 전송 후 자동으로 다음 카드로 이동

API 엔드포인트: POST /api/superchat
포인트 차감: 100포인트 (설정 가능)
```

#### 3. 매칭 생성 로직 구현
```
상호 좋아요 시 매칭을 생성하는 시스템을 구현해주세요.

구현 사항:
1. 좋아요 전송 후 상호 좋아요 확인:
   - DynamoDB에서 수신자가 나에게 보낸 좋아요 존재 여부 확인
   - 쿼리: fromUserId = 현재카드사용자ID AND toUserId = 현재로그인사용자ID

2. 매칭 생성 ('Matches' 테이블):
   - matchId: 고유 매칭 ID
   - user1Id: 사용자 ID (작은 값)
   - user2Id: 사용자 ID (큰 값)  
   - createdAt: 매칭 생성 시간
   - status: "ACTIVE"
   - lastActivity: 매칭 생성 시간

3. 매칭 성사 알림:
   - 양쪽 사용자에게 푸시 알림 전송
   - 알림 메시지: "새로운 매칭이 생겼습니다! 💕"
   - 매칭된 사용자 프로필 미리보기 포함

4. 매칭 후 처리:
   - 매칭된 사용자들은 향후 카드 스택에서 제외
   - 채팅방 자동 생성 (ChatRooms 테이블)
   - 매칭 통계 업데이트

중복 매칭 방지: 동일한 사용자 쌍의 기존 매칭 존재 여부 확인
```

#### 4. 실시간 알림 시스템 구현
```
좋아요와 슈퍼챗 수신 시 실시간 알림을 구현해주세요.

구현 사항:
1. AWS SNS 푸시 알림 설정:
   - 앱 실행 시 디바이스 토큰 등록
   - 사용자별 알림 설정 관리
   - 알림 권한 요청 및 처리

2. 알림 타입별 메시지:
   - 좋아요 수신: "[발신자명]님이 회원님을 좋아합니다 ❤️"
   - 슈퍼챗 수신: "[발신자명]님이 슈퍼챗을 보냈습니다 ⭐"
   - 매칭 성사: "새로운 매칭! [상대방명]님과 대화를 시작하세요 💕"

3. 앱 내 알림 배지:
   - 받은 좋아요 개수 표시
   - 읽지 않은 슈퍼챗 개수 표시
   - 새로운 매칭 알림 표시

4. 알림 기록 ('Notifications' 테이블):
   - notificationId: 알림 ID
   - userId: 수신자 ID
   - fromUserId: 발신자 ID
   - type: "LIKE" | "SUPERCHAT" | "MATCH"
   - message: 알림 메시지
   - isRead: 읽음 여부
   - createdAt: 알림 시간

5. 실시간 업데이트:
   - WebSocket 또는 AppSync Subscription 활용
   - 앱이 포그라운드에 있을 때 즉시 알림 표시
   - 백그라운드에서도 푸시 알림 수신
```

### 최종 통합 명령어
```
이성카드에서 좋아요와 슈퍼챗 전송 기능을 완전히 구현해주세요.

실행 순서:
1. 기존 UI 버튼들의 이벤트 핸들러에 AWS API 호출 로직 연결
2. DynamoDB 테이블 구조 확인 및 필요시 생성 (Likes, Matches, UserPoints, Notifications)
3. 좋아요 전송 → AWS 저장 → 상호 좋아요 체크 → 매칭 생성 플로우 구현
4. 슈퍼챗 전송 → 포인트 차감 → AWS 저장 → 알림 전송 플로우 구현
5. 실시간 알림 시스템 구성 (SNS 푸시 알림)
6. 에러 처리 및 사용자 피드백 로직 추가
7. 전체 플로우 테스트 및 디버깅

테스트 시나리오:
- 좋아요 전송 → 데이터베이스 저장 확인
- 상호 좋아요 → 매칭 생성 확인  
- 슈퍼챗 전송 → 포인트 차감 및 알림 확인
- 일일 제한 → 제한 메시지 표시 확인
- 네트워크 오류 → 재시도 로직 확인

성능 목표:
- 좋아요 전송: 1초 이내 완료
- 슈퍼챗 전송: 2초 이내 완료  
- 실시간 알림: 3초 이내 도착
- 매칭 생성: 1초 이내 완료
```